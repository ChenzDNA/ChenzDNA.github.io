<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>pypadb 使用文档 #2、使用装饰器进行增删改查操作 | 阿征DNA</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://chenzdna.github.io/favicon.ico?v=1643990231830">
<link rel="stylesheet" href="https://chenzdna.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="pypadb 提供了 @insert、@update、@delete、@select 四个装饰器来扩展函数。
有如下表结构：
create table test
(
    id      int unsigned auto_increme..." />
    <meta name="keywords" content="项目文档,pypadb" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://chenzdna.github.io">
        <img src="https://chenzdna.github.io/images/avatar.png?v=1643990231830" class="site-logo">
        <h1 class="site-title">阿征DNA</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
        
          <a href="/post/you-hao-de-di-fang" class="site-nav">
            出没
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      修炼大魔法师
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://chenzdna.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">pypadb 使用文档 #2、使用装饰器进行增删改查操作</h2>
            <div class="post-date">2022-01-29</div>
            
              <div class="feature-container" style="background-image: url('https://chenzdna.github.io/post-images/pypadb-shi-yong-wen-dang-2.png')">
              </div>
            
            <div class="post-content" v-pre>
              <p>pypadb 提供了 <code>@insert</code>、<code>@update</code>、<code>@delete</code>、<code>@select</code> 四个装饰器来扩展函数。</p>
<p>有如下表结构：</p>
<pre><code class="language-sql">create table test
(
    id      int unsigned auto_increment primary key,
    content varchar(255) null,
    ctime   bigint       null,
    mtime   bigint       null
);
</code></pre>
<p>实体类如下：</p>
<pre><code class="language-python">class Test(BaseModel):
    id: Optional[int]
    content: str
    ctime: Optional[int]
    mtime: Optional[int]
</code></pre>
<ul>
<li>实体类须继承 <code>pydantic.BaseModel</code>。</li>
<li>实体类的属性须添加类型注释。</li>
<li>可以为 <code>None</code> 的属性或- 不在数据库表里的属性须用 <code>Optional</code> 包裹。</li>
</ul>
<h1 id="insert">@insert</h1>
<pre><code class="language-python">from pypadb.decorator import insert

@insert('insert into test(content,ctime)')
def ins_test(test: Union[list[Test], Test]):
    # 在 insert 前修改 ctime（创建时间）为当前时间
    test.ctime = int(datetime.datetime.now().timestamp() * 1000)

# 单个插入
ins_test(Test(content='wow'))
# 批量插入
ins_test([Test(content='wow'), Test(content='123456')])
</code></pre>
<p><code>@insert</code> 装饰器接受一个参数 <code>sql: str</code>，要表明插入时的列名。</p>
<p>被装饰的函数只接受一个参数，可以为 <code>Test</code> 或者 <code>list[Test]</code>，装饰器在处理的时候会判断是否进行批量插入。</p>
<p>函数体可以为 <code>pass</code>，如果函数体不为空，则会在插入前调用函数，例如上面的代码，在插入前初始化 <code>ctime</code> 字段为当前时间。对于 <code>list[Test]</code>，装饰器同样会在插入前对每一个实体类进行处理。</p>
<p>函数的返回值是修改的最后一行主键值。</p>
<h1 id="update">@update</h1>
<pre><code class="language-python">from pypadb.decorator import update

@update('update test')
def upd_test(test: Test):
    # 在 update 前修改 mtime （修改时间）为当前时间
    test.mtime = int(datetime.datetime.now().timestamp() * 1000)

# 实体类，查询条件1，查询条件2 ...
upd_test(Test(content='wuhu'), id=1)
</code></pre>
<p><code>@update</code> 接受一个参数 <code>sql: str</code>，只需要写上需要更新的表，装饰器会根据传进来的实体对象动态生成 sql 语句。即实体对象的属性值为 <code>None</code>、空数组或者空字符串时，<code>@update</code> 会忽略这一属性。需要注意的是，若属性值为 0 时，<code>@update</code> 也会进行更新。</p>
<p>函数体可以为 <code>pass</code>，如果函数体不为空，则会在插入前调用函数，例如上面的代码，在插入前初始化 <code>mtime</code> 字段为当前时间。对于 <code>list[Test]</code>，装饰器同样会在插入前对每一个实体类进行处理。</p>
<p>被装饰的函数接受一个参数作为实体对象，还有若干指定参数作为查询条件。</p>
<p>函数的返回值是修改时的主键值。</p>
<h1 id="delete">@delete</h1>
<pre><code class="language-python">from pypadb.decorator import delete

@delete('delete from test where id=%(id)s')
def del_test(id: int = 0):
    pass
</code></pre>
<p><code>@delete</code> 装饰器接受一个值 <code>sql: str</code>，要写全。装饰器会把函数的参数列表和调用函数传进来的值做匹配，处理成一个 <code>dict</code> 交给 <code>pymysql</code> 处理。</p>
<p><code>@delete</code> 同样支持在删除前调用被装饰的函数。</p>
<h1 id="select">@select</h1>
<pre><code class="language-python">from pypadb.decorator import select

# 查询返回单个对象
@select('select * from test where id=%(id)s', data_type=Test)
def sel_test_one(id: int) -&gt; Test:
    pass

# 查询返回数组
@select(
    'select * from test where content  like concat(\'%%\',%(concat)s,\'%%\')',
    data_type=Test
)
def sel_test_many(concat: str) -&gt; list[Test]:
    pass
</code></pre>
<p><code>@select</code> 装饰器接受 2 个参数，处理 sql 语句和 <code>@delete</code> 一样，第二个参数 <code>data_type</code> 是为了将查询出来的数据包装成对象。</p>
<p><code>@select</code> 装饰器会通过反射的方式拿到函数返回值的类型注释，判断其是否为 <code>list</code> 来决定返回值是否为 <code>list</code>。若查询结果有多个，函数的返回值类型注释不是 <code>list</code> 的话，装饰器只会取结果集中的首行包装成对象返回。</p>
<p>被装饰的函数不需要有函数体，对函数体不做处理。被装饰的函数的参数列表不需要加上类型注释，当然加了更严谨。</p>
<p>2022-01-29</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://chenzdna.github.io/tag/xiang-mu-wen-dang/" class="tag">
                    项目文档
                  </a>
                
                  <a href="https://chenzdna.github.io/tag/pypadb/" class="tag">
                    pypadb
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://chenzdna.github.io/post/papadb-shi-yong-wen-dang-1an-zhuang-he-pei-zhi-xiang/">
                  <h3 class="post-title">
                    papadb 使用文档 #1、安装和配置项
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>




  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'e7a0503076500140eb19',
        clientSecret: 'ead801280c09997ad1f7c8d6c2d42f41bdfd8d0c',
        repo: 'ChenzDNA.github.io',
        owner: 'ChenzDNA',
        admin: ['ChenzDNA'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
